import { NextRequest, NextResponse } from 'next/server'
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
import { permissionChecker } from '@/lib/permissions'
import { Client } from '@/types/database'

export async function GET(request: NextRequest) {
  try {
    console.log('ğŸ” /api/clients: GETãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡')

    // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
    const cookieStore = await cookies()
    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          getAll() {
            return cookieStore.getAll()
          },
          setAll(cookiesToSet) {
            try {
              cookiesToSet.forEach(({ name, value, options }) =>
                cookieStore.set(name, value, options)
              )
            } catch {
              // The `setAll` method was called from a Server Component.
              // This can be ignored if you have middleware refreshing
              // user sessions.
            }
          },
        },
      }
    )

    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
      console.error('âŒ /api/clients: èªè¨¼ãŒå¿…è¦')
      return NextResponse.json({ error: 'èªè¨¼ãŒå¿…è¦ã§ã™' }, { status: 401 })
    }

    console.log('ğŸ‘¤ /api/clients: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.id)

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¼šç¤¾IDã‚’å–å¾—
    const { data: userData, error: userError } = await supabase
      .from('users')
      .select('company_id')
      .eq('id', user.id)
      .single()

    if (userError || !userData) {
      console.error('âŒ /api/clients: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', userError)
      return NextResponse.json({ error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' }, { status: 500 })
    }

    const companyId = userData.company_id
    console.log('ğŸ¢ /api/clients: ä¼šç¤¾ID:', companyId)

    const { data: clients, error } = await supabase
      .from('clients')
      .select('*')
      .eq('company_id', companyId)
      .order('name', { ascending: true })

    if (error) {
      console.error('âŒ /api/clients: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error)
      return NextResponse.json({ error: 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' }, { status: 500 })
    }

    console.log('âœ… /api/clients: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå–å¾—æˆåŠŸ:', clients?.length || 0, 'ä»¶')
    return NextResponse.json({ clients })
  } catch (error) {
    console.error('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error)
    return NextResponse.json({ error: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' }, { status: 500 })
  }
}

export async function POST(request: NextRequest) {
  try {
    console.log('ğŸ” /api/clients POST: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆé–‹å§‹')
    
    // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
    const cookieStore = await cookies()
    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          getAll() {
            return cookieStore.getAll()
          },
          setAll(cookiesToSet) {
            try {
              cookiesToSet.forEach(({ name, value, options }) =>
                cookieStore.set(name, value, options)
              )
            } catch {
              // The `setAll` method was called from a Server Component.
              // This can be ignored if you have middleware refreshing
              // user sessions.
            }
          },
        },
      }
    )

    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
      console.error('âŒ /api/clients POST: èªè¨¼ãŒå¿…è¦')
      return NextResponse.json({ error: 'èªè¨¼ãŒå¿…è¦ã§ã™' }, { status: 401 })
    }

    console.log('ğŸ‘¤ /api/clients POST: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.id)

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¼šç¤¾IDã‚’å–å¾—
    const { data: userData, error: userError } = await supabase
      .from('users')
      .select('company_id')
      .eq('id', user.id)
      .single()

    if (userError || !userData) {
      console.error('âŒ /api/clients POST: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', userError)
      return NextResponse.json({ error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' }, { status: 500 })
    }

    const companyId = userData.company_id
    console.log('ğŸ¢ /api/clients POST: ä¼šç¤¾ID:', companyId)

    const body = await request.json()
    const { 
      name, 
      phone, 
      address, 
      notes,
      payment_cycle_type,
      payment_cycle_closing_day,
      payment_cycle_payment_month_offset,
      payment_cycle_payment_day,
      payment_cycle_description
    } = body

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!name || typeof name !== 'string' || name.trim().length === 0) {
      return NextResponse.json({ error: 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã¯å¿…é ˆã§ã™' }, { status: 400 })
    }
    
    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ
    const clientData = {
      company_id: companyId, // ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¼šç¤¾IDã‚’ä½¿ç”¨
      name: name.trim(),
      phone: phone?.trim() || null,
      address: address?.trim() || null,
      notes: notes?.trim() || null,
      payment_cycle_type: payment_cycle_type || 'month_end',
      payment_cycle_closing_day: payment_cycle_closing_day || 31,
      payment_cycle_payment_month_offset: payment_cycle_payment_month_offset || 1,
      payment_cycle_payment_day: payment_cycle_payment_day || 31,
      payment_cycle_description: payment_cycle_description || '',
    }

    console.log('ğŸ’¾ /api/clients POST: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿:', clientData)

    const { data: client, error } = await supabase
      .from('clients')
      .insert([clientData])
      .select()
      .single()

    if (error) {
      console.error('âŒ /api/clients POST: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error)
      return NextResponse.json({ error: 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' }, { status: 500 })
    }

    console.log('âœ… /api/clients POST: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆæˆåŠŸ:', client)
    return NextResponse.json({ client }, { status: 201 })
  } catch (error) {
    console.error('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error)
    return NextResponse.json({ error: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' }, { status: 500 })
  }
}
